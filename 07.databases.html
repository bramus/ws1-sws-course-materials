<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Webscripting1 &mdash; Serverside Webscripting &mdash; 07.databases</title>

		<meta name="description" content="Webscripting1 &mdash; Serverside Webscripting &mdash; 07.databases">
		<meta name="author" content="Bram(us) Van Damme - ikdoeict.be">

		<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/main.css" media="screen">
		<link rel="stylesheet" href="css/print.css" media="print">

		<link rel="stylesheet" href="lib/zenburn.css">

		<style>
			.columns .column {
				float: left;
				list-style: none;
				margin: 0 0 12px 0;
				padding: 0;
			}

			.column-12 {
				width: 50%;
				text-align: center;
			}
			code {
				color: gainsboro;
			}

			li > code, li em > code, li del > code, li ins > code, p > code {
				background: #3F3F3F;
				padding: 2px 4px;
				box-shadow: 0px 0px 6px rgba(0,0,0,0.3);
				font-size: 80%;
			}

			del code, code.nok {
				color: #C55;
			}

			ins code, code.ok {
				color: #5C5;
			}

			strong {
				color: #553d00;
				background: transparent url('assets/02/strong.png') no-repeat 50% 50%;
				font-size: 80%;
				padding: 0 4px;
				font-family: palatino, times;
				font-weight: 300;
				font-style: italic;
			}

			#reveal section img.noborder {
				background: transparent;
				border: 0;
				-webkit-box-shadow: none;
				-moz-box-shadow: none;
				-ms-box-shadow: none;
				-o-box-shadow: none;
				box-shadow: none;"
			}

			figure.zoomable-20:hover {
				-moz-transform: scale(2);
				-o-transform: scale(2);
				-webkit-transform: scale(2);
				transform: scale(2);
			}

			#statementwarning {
				position: absolute;
				top: 0;
				left: 44px;
				right: 44px;
				bottom: 0;
				background: #1c1e20;
				opacity: 0.9;
				z-index: 99999;
				padding: 100px;
				font-family: 'League Gothic', sans-serif;
				text-shadow: 0px 0px 6px rgba(0,0,0,0.2);
				cursor: pointer;
			}

			abbr {
				border-bottom: 1px dotted #fff;
				cursor: default;
			}

		</style>

		<script>
			window.addEventListener('load', function(e) {
				$statement = document.getElementById('statementwarning');
				$statement.addEventListener('click', function(e) {
					$statement.style.display = 'none';
				});
			});
		</script>
	</head>

	<body>

		<div id="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">


				<!-- 0 : Title -->
				<section>

					<section>
						<h3 class="inverted">Serverside Webscripting <small>[JLW322]</small></h3>
						<h1>07.databases</h1>

						<footer>
							<em><a href="http://www.ikdoeict.be/">ikdoeict.be</a> &mdash; <a href="mailto:bramus.vandamme@odisee.be">bramus.vandamme@odisee.be</a></em>
						</footer>
						<script>
							// Delicously hacky. Look away.
							if( navigator.userAgent.match( /(iPhone|iPad|iPod|Android)/i ) )
							document.write( '<p style="color: rgba(0,0,0,0.3); text-shadow: none;">('+'Tap to navigate'+')</p>' );
						</script>
					</section>

				</section>




				<section>

					<section>
						<h2>Intro</h2>
					</section>

					<section>
						<h2>Choose your flavor</h2>

						<ul>
							<li class="fragment">
								Connecting to a database server from PHP possible by means of an extension
							</li>
							<li class="fragment">
								Extensions are available for most database servers
								<ul>
									<li class="fragment">MySQL, MS SQL, Oracle, &hellip;</li>
								</ul>
							</li>
							<li class="fragment">
								To connect to a MySQL server, 3 extensions exist
								<ul>
									<li class="fragment"><code>mysql</code> &mdash; Classic extension, procedural (= based on methods)</li>
									<li class="fragment"><code>mysqli</code> &mdash; Improved version of the <code>mysql</code> extension. Supports Prepared Statements, Multiple Statements, Transactions, etc. Both OO and procedural</li>
									<li class="fragment"><code>pdo_mysql</code> &mdash; OO based; Implements <em>PHP Data Objects</em>, an interface to communicating with a database server.</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>We'll choose</h2>

						<ul>
							<li class="fragment">
								DBMS? &rarr; MySQL
								<ul>
									<li class="fragment">We've already worked with this</li>
									<li class="fragment">Free</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Extension? &rarr; PDO
								<ul>
									<li class="fragment">
										The <code>mysql</code> and <code>mysqli</code> extensions are outdated
										<ul>
											<li class="fragment"><code>mysql</code> is procedural. <code>mysqli</code>'s OO form not robust as it clearly was an afterthought</li>
										</ul>
									</li>
									<li class="fragment">
										PDO is object oriented
									</li>
									<li class="fragment"><code>mysql</code> and <code>mysqli</code> are MySQL only. PDO plays nice with multiple DBMS's such as MSSQL, PostgreSQL, etc.</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Activating pdo_mysql</h2>

						<ul>
							<li class="fragment">
								Activate via <code>php.ini</code>
								<ul>
									<li class="fragment">
										Remove the leading <code>;</code> to activate<br />
										<div style="text-align: center;"><figure><img src="assets/07/phpini.jpg" width="600" alt="" title="" /></figure></div>
									</li>
									<li class="fragment">Already activated in Wampserver</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Verify activation</h2>

						<ul>
							<li class="fragment">
								Use <code>phpinfo()</code> to check if PDO and <code>pdo_mysql</code> are activated
							</li>
						</ul>
						<div style="text-align: center;" class="fragment"><figure><img src="assets/07/phpinfo.jpg" alt="" title="" width="600" /></figure></div>
					</section>


				</section>




				<section>

					<section>
						<h2>Connecting &amp; Disconnecting</h2>
					</section>

					<section>
						<h2>First of all</h2>

						<ul>
							<li class="fragment">
								We'll use a <code>config.php</code> to store our credentials in

								<pre class="bigger"><code class="language-php">&lt;?php

		define('DB_HOST', 'localhost');
		define('DB_USER', 'root');
		define('DB_PASS', 'Azerty123');

		define('DB_NAME_FF', 'fotofactory');
		define('DB_NAME_STATUS', 'status');

//EOF</code></pre>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								The config is used throughout the next code examples
								<ul class="fragment">
									<li>Edit the file if needed (location: <code>/assets/07/examples</code>)</li>
								</ul>
							</li>
							<li class="fragment">SQL Dumps of the used databases also in that folder</li>
						</ul>
					</section>

					<section>
						<h2>Connecting (1)</h2>

						<ul>
							<li class="fragment">
								Connect by creating a new instance of <code>PDO</code> with params:
								<ol>
									<li>A <abbr title="Data Source Name">DSN</abbr>, containing the database host, schema, and charset</li>
									<li>The username to use when connecting to the DBMS</li>
									<li>The password to use when connecting to the DBMS</li>
								</ol>
							</li>
						</ul>
						<div class="fragment"><pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/01.php">&lt;?php

	require_once 'config.php';

	$db = new PDO('mysql:host=' . DB_HOST .';dbname=' . DB_NAME_FF . ';charset=utf8mb4', DB_USER, DB_PASS);

	echo 'Connected to the database';

//EOF</code></pre></div>
						<footer class="fragment"><em>(More on that charset later)</em></footer>
					</section>

					<section>
						<h2>Disconnecting?</h2>

						<ul>
							<li class="fragment">
								Not needed
								<ul>
									<li class="fragment">When the script has finished, the variable dies with it</li>
								</ul>
							</li>
						</ul>

					</section>

				</section>




				<section>

					<section>
						<h2>Catching Errors</h2>
					</section>

					<section>
						<h2>Let's break things</h2>

						<ul>
							<li class="fragment">PHP will tell you if something went wrong</li>
						</ul>

						<div class="fragment">

							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/02.php">&lt;?php

	// Include config
	require_once 'config.php';

	// Make Connection
	$db = new PDO('mysql:host=' . DB_HOST .';dbname=does_not_exist;charset=utf8mb4', DB_USER, DB_PASS);

	echo 'Connected to the database';

	// ... your query magic here
</code></pre>

							<pre class="bigger"><code>Fatal error: Uncaught exception 'PDOException' with message 'SQLSTATE[42000] [1049] Unknown database 'does_not_exist'' in /Users/bramus/Dropbox/Kaho/.../assets/07/examples/02.php:7 Stack trace: #0 /Users/bramus/Dropbox/Kaho/.../assets/07/examples/02.php(7): PDO->__construct('mysql:host=loca...', 'root', 'Azerty123') #1 {main} thrown in /Users/bramus/Dropbox/Kaho/Lesactiviteiten/WS1 - Serverside/2013-2014/slidedeck/assets/07/examples/02.php on line 7</code></pre>
						</div>
					</section>

					<section>
						<h2>Don't show errors on screen!</h2>
						<ul>
							<li class="fragment">
								Showing errors on screen is a huge security issue!
								<ul>
									<li class="fragment">Users can get a glimpse of your DB credentials</li>
									<li class="fragment">Users can get a glimpse of your DB layout</li>
									<li class="fragment">Users know the physical location of your website</li>
								</ul>
							</li>
						</ul>
						<div class="fragment"><figure class="zoomable-20"><img src="assets/07/tomorrowland.jpg" alt="" title="" width="300" /><figcaption>Example: Tomorrowland website</figcaption></figure></div>
					</section>

					<section>
						<h2>Catching Errors</h2>
						<ul>
							<li class="fragment">
								An exception will be thrown when PDO cannot connect to the database server or access database.
								<ul>
									<li class="fragment">&rarr; Use a <code>try/catch</code> struct</li>
								</ul>

								<div class="fragment">

							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/02b.php">try {
	$db = new PDO('mysql:host=' . DB_HOST .';dbname=does_not_exist;charset=utf8mb4', DB_USER, DB_PASS);
} catch (Exception $e) {
	exit('Could not connect to database server or access database');
}</code></pre>

						</div>

							</li>
							<li class="fragment">
								Safer, as we don't expose our DB credentials to potential hackers anymore
							</li>
						</ul>
					</section>

					<section>
						<h2>Userfriendly error messages</h2>
						<ul>
							<li class="fragment">
								Better: Show user-friendly messages on screen

								<div class="fragment">

									<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/02c.php">&lt;?php

	function showDbError($type) {
		header('location: error.php?type=db&amp;detail=' . $type);
		exit();
	}

	require_once 'config.php';

	try {
		$db = new PDO('mysql:host=' . DB_HOST .';dbname=does_not_exist;charset=utf8mb4', DB_USER, DB_PASS);
	} catch (Exception $e) {
		showDbError('connect');
	}

//EOF</code></pre>

								</div>

							</li>
						</ul>
					</section>

					<section>
						<h2>Logging errors</h2>
						<ul>
							<li class="fragment">
								As a developer I'm not interested in a userfriendly error message, I want to see the actual error in a logfile
								<ul>
									<li class="fragment">&rarr; Pass the Exception message into <code>showDbError()</code> and log it in a file/db</li>
								</ul>
							</li>
						</ul>

						<div class="fragment">

							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/02d.php">&lt;?php

	function showDbError($type, $msg) {
		file_put_contents(
			__DIR__ . '/error_log_mysql',
			PHP_EOL . (new DateTime())->format('Y-m-d H:i:s') . ' : ' . $msg,
			FILE_APPEND
		);
		header('location: error.php?type=db&amp;detail=' . $type);
		exit();
	}

	try {
		$db = new PDO('mysql:host=' . DB_HOST .';dbname=does_not_exist;charset=utf8mb4', DB_USER, DB_PASS);
	} catch (Exception $e) {
		showDbError('connect', $e->getMessage());
	}</code></pre>

						</div>

					</section>

					<section>
						<h2>Summary / Course Convention</h2>
						<ul>
							<li class="fragment">
								Never ever show errors on screen on a published site
								<ul class="fragment">
									<li>Log them for the developer</li>
									<li>Present the user a userfriendly error message, in an understandable language and preferably in the layout of the site</li>
								</ul>
							</li>
					</section>

				</section>




				<section>

					<section>
						<h2>Executing Queries</h2>
					</section>

					<section>
						<h2>Types of Queries</h2>

						<ul>
							<li class="fragment">
								Essentially, we have two types of queries. Queries that:
								<ol>
									<li class="fragment">Yield a resultset (e.g. <code>SELECT</code>, <code>SHOW</code>, <code>DESCRIBE</code>, <code>EXPLAIN</code>, &hellip;)</li>
									<li class="fragment">Yield no resultset (e.g. <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>, <code>DROP</code>, &hellip;)</li>
								</ol>
							</li>
						</ul>
					</section>

					<section>
						<h2>Executing Queries</h2>
						<ul>
							<li class="fragment">
								Depending on the type of query, use one of these functions
								<div class="fragment">
									<ol style="margin-top: 1em;">
										<li>Use <code>PDO::query()</code><small><a href="http://www.php.net/manual/en/pdo.query.php">&#9873;</a></small> for queries that yield a resultset</li>
									</ol>
									<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/03.php">$stmt = $db->query('SELECT * FROM collections WHERE user_id = 2');
var_dump($stmt);</code></pre>
								</div>
								<div class="fragment">
									<ol start="2">
										<li>Use <code>PDO::exec()</code><small><a href="http://www.php.net/manual/en/pdo.exec.php">&#9873;</a></small> for queries that yield no resultset</li>
									</ol>
									<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/03b.php">$stmt = $db->exec('DELETE FROM collections WHERE user_id = 10');
var_dump($stmt);</code></pre>
								</div>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Depending on the type of query, we'll need to do some more things to get an actual result we can use <em>(See further)</em>
							</li>
						</ul>
					</section>

					<section>
						<h2>Executing Faulty Queries</h2>
						<ul>
							<li class="fragment">
								When you write a faulty query <em>(wrong syntax, inexistent table referenced, etc)</em> it will fail silently
								<ul>
									<li class="fragment">
										As a developer, you don't want this; you want to know where you messed up and fix it.
									</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Call <code>PDO::setAttribute()</code><small><a href="http://www.php.net/manual/en/pdo.setattribute.php">&#9873;</a></small> to change the error mode so that exceptions are thrown when a faulty query is executed
								<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/03c.php">try {
	$db = new PDO('mysql:host=' . DB_HOST .';dbname=' . DB_NAME_FF . ';charset=utf8mb4', DB_USER, DB_PASS);
	$db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (Exception $e) {
	showDbError('connect', $e->getMessage());
}

$stmt = $db->exec('DELETE FROM inexistent_table WHERE user_id = 10');</code></pre>
							</li>
						</ul>
					</section>

				</section>




				<section>

					<section>
						<h2>Working with query parameters</h2>
					</section>

					<section>
						<h2>Working with query parameters</h2>

						<ul>
							<li class="fragment">When using user input as parameters for a query, don't pass it in directly, <strong>always</strong> secure the passed in data first</li>
							<li class="fragment" style="margin-top: 1em;">
								If you don't, users can perform SQL Injection
								<ul>
									<li>Just as XSS, <a href="http://blogs.msdn.com/b/ie/archive/2012/09/10/xss-trends-and-internet-explorer.aspx">SQL Injection is a real world and big problem</a>!</li>
									<li><em>&ldquo;SQL injection is the most pernicious vulnerability in human computer history&rdquo;</em> (<a href="http://blog.imperva.com/2011/09/sql-injection-by-the-numbers.html">source</a>)</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Let's take a closer look on the next few slides &hellip;
							</li>
						</ul>

						<footer class="fragment"><em style="color: #F55;">!! If you don't prevent SQL Injection in the assignments or your exam, you will fail them !!</em></footer>

					</section>

					<section>
						<h2>(Insecure) Example</h2>

						<ul>
							<li class="fragment">
								Detailpage of a collection. Url: <code>detail.php?id=X</code>

								<pre class="bigger"><code class="language-php">&lt;?php

&hellip;

	// Get ID from URL
	$id = isset($_GET['id']) ? $_GET['id'] : 0;

	// Get collection from database
	$stmt = $db->query('SELECT * FROM collections WHERE id = ' . $id);

	// Handle result

&hellip;
</code></pre>
							</li>
						</ul>
					</section>

					<section>
						<h2>Problem #1</h2>

						<ul>
							<li class="fragment">
								Changing the URL param to a string will break the query
								<ul>
									<li>When visiting <code>detail.php?id=test</code> the query will become broken: <code class="nok" style="white-space: nowrap;">SELECT * FROM collections WHERE id = test</code> is an invalid query</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Fix: add quotes in your query around the value
								<ul>
									<li><code class="ok">SELECT * FROM products WHERE id = &quot;test&quot;</code> is a valid query</li>
								</ul>
								<div class="fragment">
									<pre class="bigger"><code class="language-php">$stmt = $db->query('SELECT * FROM collections WHERE user_id = &quot;' . $id . '&quot;');</code></pre>
								</div>
							</li>
						</ul>
					</section>

					<section>
						<h2>Problem #2</h2>

						<ul>
							<li class="fragment">
								Changing the URL param to a string containing a quote breaks the query
								<ul>
									<li>When visiting <code>detail.php?id=te&quot;st</code> the query will become broken: <code class="nok" style="white-space: nowrap;">SELECT * FROM products WHERE id = &quot;te&quot;st&quot;</code> is an invalid query</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 0.5em;">
								Possible fix: use <code>addslashes()</code>
								<ul>
									<li><code class="ok">SELECT * FROM products WHERE id = &quot;te\&quot;st&quot;</code> is a valid query</li>
								</ul>

								<div class="fragment">
									<pre class="bigger"><code class="language-php">$stmt = $db->query('SELECT * FROM collections WHERE user_id = &quot;' . addslashes($id) . '&quot;');</code></pre>
								</div>
							</li>
							<li class="fragment" style="margin-top: 0.5em;">
								Possible fix: cast <code>$id</code> to an integer
								<div class="fragment">
									<pre class="bigger"><code class="language-php">$stmt = $db->query('SELECT * FROM collections WHERE id = ' . (int) $id);</code></pre>
								</div>
								<ul>
									<li class="fragment">Won't work if you expect a string though!</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Problem #2 (variant)</h2>

						<ul>
							<li class="fragment">
								Changing the URL param to a <em>dangerous</em> string that resembles SQL results in <strong>SQL injection</strong>
								<div class="fragment" style="text-align: center; padding-top: 20px">
									<figure class="zoomable-20">
										<img src="assets/07/littlebobbytables.jpg" alt="" title="" width="400" />
										<figcaption><a href="http://xkcd.com/327/">XKCD: Exploits of a mom</a></figcaption>
									</figure>
								</div>
							</li>
							<li class="fragment">
								Fix: use <code>addslashes()</code>? <span class="fragment">Alas, no dice:</span>
								<ul class="fragment">
									<li>
										Multibyte characters used with certain DB encodings break stuff:
										<ul>
											<li class="fragment">
												PHP's <code>addslashes()</code> does not recognize the multibyte char <code>0xbf27</code> (&#xBF27;) and treats it as two single bytes: <code>0xBF</code> (&#xBF;) and <code>0x27</code> (&#x27;) &rarr; PHP will escape that <code>0x27</code> with a backslash (<code>0x5c</code>) and we end up with the char sequence <code>0xbf5c27</code>
											</li>
											<li class="fragment">
												MySQL with a GBK charset connection recognizes <code>0xbf5c</code> (&#xBF5C;) as a multibyte char, leaving an unescaped <code>0x27</code> in the query (!) &rarr; Boom, you've just injected a single quote.
											</li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>What now?</h2>

						<ul>
							<li class="fragment">
								Sanitize the parameters using the MySQL connection
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Two options
								<ol>
									<li>Manually escape all parameters</li>
									<li>Use prepared statements</li>
								</ol>
							</li>
						</ul>
					</section>

					<section>
						<h2>Manually escaping parameters</h2>
						<ul>
							<li class="fragment">
								Use <code>PDO::quote()</code><small><a href="http://www.php.net/manual/en/pdo.quote.php">&#9873;</a></small> to escape a parameter properly
								<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/04.php">$stmt = $db->query('SELECT * FROM collections WHERE id = ' . $db->quote($userId, PDO::PARAM_INT));</code></pre>
							</li>
							<li class="fragment">
								Note
								<ul>
									<li class="fragment">
										Charset must be set on the DSN!
										<pre class="bigger"><code class="language-php">$db = new PDO('mysql:host=' . DB_HOST .';dbname=' . DB_NAME_FF . ';charset=utf8mb4', DB_USER, DB_PASS);
</code></pre>
									</li>
									<li class="fragment">
										<code>PDO::quote()</code> will add quotes around the value where needed
										<pre class="bigger"><code class="language-php">$stmt = $db->query('SELECT * FROM collections WHERE name = ' . $db->quote($name, PDO::PARAM_STR));</code></pre>
									</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Prepared Statements (1)</h2>
						<ul>
							<li class="fragment">
								Mingling parameters into your query will become confusing when having lots of parameters
								<ul>
									<li class="fragment">
										&rarr; Prepared statements overcome this
									</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Prepared statements also prevent SQL Injection, but only if
								<ul>
									<li class="fragment">
										You use it properly
									</li>
									<li class="fragment">
										You instruct it to disable emulated prepares using <code style="white-space: nowrap; font-size: 70%;">$db->setAttribute(PDO::ATTR_EMULATE_PREPARES, false);</code>
										<pre class="bigger"><code class="language-php">// Make Connection
try {
	$db = new PDO('mysql:host=' . DB_HOST .';dbname=' . DB_NAME . ';charset=utf8mb4', DB_USER, DB_PASS);
	$db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
	$db->setAttribute(PDO::ATTR_EMULATE_PREPARES, false);
} catch (Exception $e) {
	showDbError('connect', $e->getMessage());
}</code></pre></li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Prepared Statements (2)</h2>
						<ul>
							<li class="fragment">
								Use <code>PDO::prepare()</code><small><a href="http://www.php.net/manual/en/pdo.quote.php">&#9873;</a></small> to <em>prepare</em> a query with placeholders
								<pre class="bigger"><code class="language-php">$stmt = $db->prepare('SELECT * FROM collections WHERE id = ?');</code></pre>
								<ul>
									<li class="fragment">Everywhere you would add a parameter in the query, replace it by a <code>?</code></li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em">
								The result is an instance of <code>PDOStatement</code><small><a href="http://www.php.net/manual/en/class.pdostatement.php">&#9873;</a></small>. With it:
								<ul>
									<li class="fragment">Bind values onto the placeholders</li>
									<li class="fragment">Execute it</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Using Prepared Statements (1)</h2>
						<ul>
							<li class="fragment">
								Bind values onto the placeholders using <code>PDOStatement::bindValue()</code><small><a href="http://www.php.net/manual/en/pdostatement.bindvalue.php">&#9873;</a></small>
								<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/04b.php">$stmt = $db->prepare('SELECT * FROM collections WHERE id = ?');
$stmt->bindValue(1, $id, PDO::PARAM_INT);
$stmt->execute();</code></pre>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Alternative: named placeholders
								<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/04c.php">$stmt = $db->prepare('SELECT * FROM collections WHERE id = :id');
$stmt->bindValue(':id', $id, PDO::PARAM_INT);
$stmt->execute();</code></pre>
							</li>
						</ul>
						<footer class="fragment"><em>Note: You call execute on the statement, not on <code>$db</code></em></footer>
					</section>

					<section>
						<h2>Using Prepared Statements (2)</h2>
						<ul>
							<li class="fragment">
								Also possible <em>(shorter, preferred)</em>:
								<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/04d.php">$stmt = $db->prepare('SELECT * FROM collections WHERE id = ?');
$stmt->execute(array($id));</code></pre>
								<ul>
									<li class="fragment">Cannot be used with named placeholders</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								No matter what type of query is, the call is always <code>PDOStatement::execute()</code><small><a href="http://www.php.net/manual/en/pdostatement.execute.php">&#9873;</a></small>
								<pre class="bigger"><code class="language-php">$stmt = $db->prepare('INSERT INTO collections (name, user_id) VALUES (?, ?)');
$stmt->execute(array('bramus-test', 4));</code></pre>
							</li>
						</ul>
					</section>

					<section>
						<h2>Summary</h2>

						<ul>
							<li class="fragment">
								<strong>Always</strong> sanitize &amp; escape user input when constructing queries to prevent SQL Injection
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Preference to using <em>prepared statements</em>
								<ul>
									<li>More readable code</li>
									<li><em>One function to rule them all &trade;</em></li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Remember to manually force <strong>real prepared statements</strong>!
								<pre class="bigger"><code class="language-php">$db->setAttribute(PDO::ATTR_EMULATE_PREPARES, false);</code></pre>
							</li>
						</ul>

						<footer class="fragment"><em style="color: #F55;">!! If you don't prevent SQL Injection in the assignments or your exam, you will fail them !!</em></footer>

					</section>

				</section>


				<section>

					<section>
						<h2>Processing queries</h2>
					</section>

					<section>
						<h2>Processing queries</h2>

						<ul>
							<li class="fragment">We can now properly write queries</li>
							<li class="fragment" style="margin-top: 1em;">
								As said before: depending on the type of query, we'll need to do some more things to get an actual result we can use
							</li>
						</ul>
					</section>

					<section>
						<h2>Fetching an entire resultset</h2>
						<ul>
							<li class="fragment">
								Use <code>PDOStatement::fetchAll()</code><small><a href="http://www.php.net/manual/en/pdostatement.fetchall.php">&#9873;</a></small> to fetch the entire resultset into an array
								<ul>
									<li class="fragment">Pass in a <em>fetch style</em> to shape the contents of that array</li>
								</ul>
							</li>
						</ul>
						<div class="fragment">
							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/05.php">$stmt =$db->prepare('SELECT * FROM collections WHERE user_id = ? OR name = ?');
$stmt->execute(array(2, 'russia'));
$collections = $stmt->fetchAll(PDO::FETCH_ASSOC);

echo '&lt;pre&gt;';
var_dump($collections);
echo '&lt;/pre&gt;';</code></pre>
						</div>
						<div class="fragment">
							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/05b.php">$collections = $stmt->fetchAll(PDO::FETCH_OBJ);</code></pre>
						</div>
					</section>

					<section>
						<h2>Fetching a single row</h2>
						<ul>
							<li class="fragment">
								Use <code>PDOStatement::fetch()</code><small><a href="http://www.php.net/manual/en/pdostatement.fetch.php">&#9873;</a></small> to fetch the returned rows one bye one
								<div class="fragment">
									<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/05c.php">$stmt =$db->prepare('SELECT * FROM collections WHERE user_id = ? OR name = ?');
$stmt->execute(array(2, 'russia'));

while ($collection = $stmt->fetch(PDO::FETCH_ASSOC)) {
	var_dump($collection);
}</code></pre>
								</div>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Use case: queries that yield one row
								<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/05d.php">$stmt = $db->prepare('SELECT * FROM collections WHERE id = ?');
$stmt->execute(array(1));

$collection = $stmt->fetch(PDO::FETCH_ASSOC);
var_dump($collection);</code></pre>
							</li>
						</ul>
					</section>

					<section>
						<h2>Fetching a single field</h2>
						<ul>
							<li class="fragment">
								Use <code>PDOStatement::fetchColumn()</code><small><a href="http://www.php.net/manual/en/pdostatement.fetchColumn.php">&#9873;</a></small> to fetch the value of a column from the first row
								<div class="fragment">
									<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/05e.php">$stmt = $db->prepare('SELECT name, user_id FROM collections WHERE id = ?');
$stmt->execute(array(1));
var_dump($stmt->fetchColumn());</code></pre>
								</div>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Use an index to define which column you want
								<div class="fragment">
									<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/05f.php">$stmt = $db->prepare('SELECT name, user_id FROM collections WHERE id = ?');
$stmt->execute(array(1));
var_dump($stmt->fetchColumn(1));</code></pre>
								</div>
							</li>
						</ul>
					</section>

					<section>
						<h2>Fetching meta information</h2>
						<ul>
							<li class="fragment">
								Use <code>PDO::lastInsertId()</code><small><a href="http://www.php.net/manual/en/pdo.lastinsertid.php">&#9873;</a></small> to know the last inserted id (<code>AUTO_INCREMENT</code>) after executing an <code>INSERT</code> query
								<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/06.php">$stmt = $db->prepare('INSERT INTO collections(name, user_id) VALUES (?,?)');
$stmt->execute(array('Trip to Amsterdam', 10));

echo 'Created album with ID ' . $db->lastInsertId();</code></pre>
							</li>
							<li class="fragment" style="margin-top: 1em">
								Use <code>PDOStatement::rowCount()</code><small><a href="http://www.php.net/manual/en/pdostatement.rowcount.php">&#9873;</a></small> to know the number of affected rows made by <code>UPDATE</code> and <code>DELETE</code> queries
								<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/07.php">$stmt = $db->prepare('DELETE FROM collections WHERE user_id = ?');
$stmt->execute(array(10));

echo 'Deleted ' . $stmt->rowCount() . ' rows';</code></pre>
								<ul>
									<li class="fragment"><em>Note: matched rows which aren't updated are not included in this count!</em></li>
								</ul>
							</li>
						</ul>
					</section>


				</section>




				<section>

					<section>
						<h2>Best Practices</h2>
					</section>


					<section>
						<h2>Best Practices?</h2>

						<ul>
							<li class="fragment">
								A set of often used methods / tips to help you working with databases
								<ol>
									<li class="fragment">UTF-8</li>
									<li class="fragment">Working with dates and time</li>
									<li class="fragment">Joins over loops</li>
									<li class="fragment">Passwords</li>
								</ol>
							</li>
						</ul>
					</section>

					<section>
						<h2>Best Practice #1<br /><br />UTF-8</h2>
					</section>

					<section>
						<h2>UTF-8</h2>
						<ul>
							<li class="fragment">
								In short: Use <code>UTF-8</code>, everywhere.
								<ol>
									<li class="fragment">
										DB Schema and Tables
									</li>
									<li class="fragment">
										DB Connection
									</li>
									<li class="fragment">
										HTML charset
									</li>
								</ol>
							</li>
							<li class="fragment" style="margin-top: 1em">If you omit one of them, it will not work as expected.</li>
						</ul>
					</section>

					<section>
						<h2>UTF-8, everywhere</h2>
								<ol>
									<li class="fragment">
										DB Schema and Tables: use <code>utf8mb4</code>/<code>utf8mb4_unicode_ci</code>
										<pre class="bigger"><code>CREATE DATABASE `mydb`
DEFAULT CHARACTER SET utf8mb4 DEFAULT COLLATE utf8mb4_unicode_ci;</code></pre>
										<pre class="bigger"><code>CREATE TABLE IF NOT EXISTS `records` (
	`id` INT(10) NOT NULL AUTO_INCREMENT,
	`name` VARCHAR(255) NOT NULL,
	PRIMARY KEY (`id`)
) ENGINE = InnoDB
DEFAULT CHARACTER SET utf8mb4 DEFAULT COLLATE utf8mb4_unicode_ci;</code></pre>
									</li>
									<li class="fragment">
										DB Connection
										<pre class="bigger"><code class="language-php">$db = new PDO('mysql:host=' . DB_HOST .';dbname=' . DB_NAME_FF . ';charset=utf8mb4', DB_USER, DB_PASS);</code></pre>
									</li>
									<li class="fragment">
										HTML charset
										<pre class="bigger"><code class="language-html dontrun">&lt;meta charset=&quot;utf-8&quot; /&gt;</code></pre>
									</li>
								</ol>
					</section>

					<section>
						<h2>UTF-8 charset in MySQL, sidenote</h2>
						<ul>
							<li class="fragment">MySQL sports multiple UTF-8 character sets</li>
							<li class="fragment" style="margin-top: 1em">The original UTF-8 charset supported (<code>utf8</code>) was incomplete: it didn't support astral symbols <em>(= <a href="http://www.grumdrig.com/emoji-list/">emoji</a>)</em>, which require 4 byte encoding</li>
							<li class="fragment" style="margin-top: 1em">Fixed in MySQL 5.5.3 by the addition of <code>utf8mb4</code> charset<br />&rarr; Always use <code>utf8mb4</code></li>
						</ul>
						<footer class="fragment">More info: <a href="http://mathiasbynens.be/notes/mysql-utf8mb4">http://mathiasbynens.be/notes/mysql-utf8mb4</a></footer>
					</section>

					<section>
						<h2>Best Practice #2<br /><br />Working with dates and time</h2>
					</section>


					<section>
						<h2>Dates in MySQL</h2>

						<ul>
							<li class="fragment">
								Current timestamp accessible with <code>NOW()</code>
							</li>
							<li class="fragment">
								From timestamp to a readable format with <code>date_format()</code>
								<ul>
									<li class="fragment">
										Example
										<pre class="bigger"><code class="language-php">SELECT date_format(&quot;%Y-%m-%d&quot;, publishTimestamp) AS readabledate FROM ...</code></pre>
									</li>
									<li class="fragment">Most format directives the same as in PHP but with leading <code>%</code></li>
									<li class="fragment">See <a href="http://dev.mysql.com/doc/refman/5.1/en/date-and-time-functions.html #function_date-format">mysql docs</a> for more info</li>
								</ul>
							</li>
							<li class="fragment">
								From datestring to timestamp with <code>unix_timestamp()</code>
								<ul>
									<li class="fragment">
										Example
										<pre class="bigger"><code class="language-php">SELECT unix_timestamp(publishDateTime) AS timestamp FROM ...</code></pre>
									</li>
								</ul>
							</li>
						</ul>
					</section>


					<section>
						<h2>Date &amp; time best practices (1)</h2>

						<ul>
							<li class="fragment">
								Never combine PHP and MySQL time
								<ul class="fragment">
									<li>Funky situations where mysql server clock is ahead of webserver</li>
									<li>Our choice: let webserver (thus PHP) decide what time it is</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Store dates in a readable format in your database
								<ul>
									<li class="fragment">
										Timestamps are not that readable when looking at raw dumps
									</li>
									<li class="fragment">
										Use <code>datetime</code> as the field type
										<ul>
											<li>Beware: does not contain timezone information!</li>
											<li>Sidenote: If you ever were to make a timezone aware app store all dates/times as UTC in your DB</li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
					</section>


					<section>
						<h2>Date &amp; time best practices (2)</h2>
						<ul>
							<li class="fragment">
								Convert dates in PHP, not in your queries (unless necessary)
								<ul>
									<li class="fragment">
										Prevents complex queries
									</li>
									<li class="fragment">
										Examples
										<ul>
											<li>Storing dates: <code>$data['publish_date'] = (new Datetime())->format('Y-m-d H:i:s');</code></li>
											<li>Displaying dates: <code>$month = (new Datetime($dbResult['publish_date']))->format('m')</code></li>
										</ul>
									</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Don't be too specific when retrieving items after/before a given date. Bad example:
								<pre class="bigger"><code class="language-php">$stmt = $db->prepare('SELECT * FROM blogposts WHERE publish_date ?');
$stmt->execute(array((new DateTime())->format('Y-m-d H:i:s')));</code></pre>
								<ul>
									<li class="fragment">MySQL Query Cache won't cache this</li>
									<li class="fragment">Fix: Round your dates to the minute or 5 minutes if the script allows it</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Best Practice #3<br /><br />Joins over loops</h2>
					</section>


					<section>
						<h2>Example</h2>

						<ul>
							<li class="fragment">
								Detailpage of a blogpost
								<ul>
									<li>Shows blogpost</li>
									<li>Allow comments on blogpost</li>
									<li>Author information stored separately in database</li>
								</ul>
							</li>
						</ul>
					</section>


					<section>
						<h2>Bad execution</h2>

						<ul>
							<li class="fragment">
								Execute queries inside a loop
								<pre class="bigger"><code class="language-php">$id = (int) isset($_GET['id']) ? $_GET['id'] : 0;

$stmt = $db->prepare('SELECT id, title, content FROM blogs WHERE id = ?');
$stmt->execute(array($id));
$blogpost = $stmt->fetch(PDO::FETCH_ASSOC);

$stmt = $db->prepare('SELECT id, blog_id, comment, publishdate, author_id FROM comments WHERE blog_id = ?');
$stmt->execute(array($id));
$comments = $stmt->fetchAll(PDO::FETCH_ASSOC);

foreach ($comments as $c) {
	$stmt = $db->prepare('SELECT * FROM authors WHERE id = ?');
	$stmt->execute(array($c['author_id']));
	$author = $stmt->fetch(PDO::FETCH_ASSOC);

	// &hellip; show comment + author info
}</code></pre>
								<ul>
									<li>
										With 50 comments, 52 queries are executed
										<ul>
											<li>1 x get blogpost, 1 x get comments, 50 x get authorinfo</li>
										</ul>
								</ul>
							</li>
						</ul>
					</section>


					<section>
						<h2>Proper execution</h2>

						<ul>
							<li class="fragment">
								Use a JOIN to minimize the number of executed queries
								<pre class="bigger"><code class="language-php">$id = (int) isset($_GET['id']) ? $_GET['id'] : 0;

$stmt = $db->prepare('SELECT id, title, content FROM blogs WHERE id = ?');
$stmt->execute(array($id));
$blogpost = $stmt->fetch(PDO::FETCH_ASSOC);

$stmt = $db->prepare('SELECT c.id, c.blog_id, c.comment, c.publishdate, c.author_id, a.name, a.email, a.url FROM comments AS c INNER JOIN authors AS a ON c.author_id = a.id WHERE c.blog_id = ?');
$stmt->execute(array($id));
$comments = $stmt->fetchAll(PDO::FETCH_ASSOC);

foreach ($comments as $c) {
	// &hellip; show comment + author info
}</code></pre>
								<ul>
									<li>
										With 50 comments, 2 queries are executed
										<ul>
											<li>1 x get blogpost, 1 x get comments with authorinfo</li>
										</ul>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Best Practice #4<br /><br />Encrypt passwords</h2>
					</section>


					<section>
						<h2>Encrypt passwords (1)</h2>

						<ul>
							<li class="fragment">
								You must <strong>always</strong> encrypt stored passwords. Never store them as plaintext
								<ul>
									<li>If you don't, it's very easy for a hacker to steal lots of passwords if he ever got access to your database</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Beware of old code/examples:
								<ul>
									<li class="fragment">
										<code>md5()</code><small><a href="http://php.net/md5">&#9873;</a></small> and <code>sha1()</code><small><a href="http://php.net/sha1">&#9873;</a></small> <a href="http://www.slideshare.net/ircmaxell/password-storage-and-attacking-in-php">are outdated/too weak</a>, don't use them
									</li>
									<li class="fragment"><code>crypt()</code><small><a href="http://php.net/crypt">&#9873;</a></small> strong but no long preferred</li>
								</uL>
							</li>
						</ul>

						<footer class="fragment"><em style="color: #F55;">!! If you don't encrypt your passwords in the assignments or your exam, you will fail them !!</em></footer>
					</section>

					<section>
						<h2>Encrypt passwords (2)</h2>
						<ul>
							<li class="fragment">
								Use <code>password_hash()</code><small><a href="http://php.net/password_hash">&#9873;</a></small> and <code>password_verify()</code><small><a href="http://php.net/password_verify">&#9873;</a></small>
								<ul>
									<li class="fragment">Uses a strong one-way hashing algorithm</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em">
								Encrypting a password:
								<pre class="bigger"><code class="language-php">echo password_hash('bramus', PASSWORD_DEFAULT); // store this into your DB</code></pre>
							</li>
							<li class="fragment" style="margin-top: 1em">
								Verifying a password:
								<pre class="bigger"><code class="language-php">$pass = isset($_POST['password']) ? $_POST['password'] : '';
// Value as stored in database
$encrypted = '$2y$10$Ae/ZoEnFze9SZKcgbNBluOObABeejekNoJ2iNmyf4QM5IYSIyzFPe';

if (password_verify($pass, $encrypted)) { &hellip; }</code></pre>
							</li>
						</ul>
						<footer class="fragment"><em>Note: these functions are new since PHP 5.5. When using 5.4, include <a href="https://github.com/ircmaxell/password_compat/blob/master/lib/password.php">this polyfill</a>.</em></footer>
					</section>

				</section>




				<section>

					<section>
						<h2>Extra: PhpMyAdmin</h2>
					</section>

					<section>
						<h2>Demo time!</h2>

						<figure><img src="assets/07/phpmyadmin.png" alt="" title="" width="600" /></figure>

					</section>

					<section>
						<h2>Demo Recap</h2>

						<ul>
							<li class="fragment">Import/Export databases</li>
							<li class="fragment">Create tables</li>
							<li class="fragment">Insert/Update data</li>
							<li class="fragment">Run Queries</li>
							<li class="fragment">Add users and set privileges</li>
						</ul>

					</section>

				</section>

				<!-- The END -->
				<section>
					<section>
						<h2>Questions?</h2>
						<footer>
							<em><a href="http://www.ikdoeict.be/">ikdoeict.be</a> &mdash; <a href="mailto:bramus.vandamme@odisee.be">bramus.vandamme@odisee.be</a></em>
						</footer>
					</section>
				</section>



				<!-- Summary -->
				<section id="summary">

					<section>
						<h2>Code summary</h2>

						<p style="margin-top: 5.5em;"><em>A code-only summary of this chapter is available at <a href="07.databases.summary.html">07.databases.summary.html</a></em></p>
						<footer>
							<em>Note: not all information from these slides can be found in this summary!</em>
						</footer>

					</section>

				</section>



				<!-- Sources -->
				<section id="sources">
					<section>
						<h2>Sources</h2>
						<ul>
							<li><a href="http://wiki.hashphp.org/PDO_Tutorial_for_MySQL_Developers">http://wiki.hashphp.org/PDO_Tutorial_for_MySQL_Developers</a></li>
							<li><a href="http://net.tutsplus.com/tutorials/php/why-you-should-be-using-phps-pdo-for-database-access/">http://net.tutsplus.com/tutorials/php/why-you-should-be-using-phps-pdo-for-database-access/</a></li>
							<li><a href="http://www.kitebird.com/articles/php-pdo.html">http://www.kitebird.com/articles/php-pdo.html</a></li>
							<li><a href="http://shiflett.org/blog/2006/jan/addslashes-versus-mysql-real-escape-string">http://shiflett.org/blog/2006/jan/addslashes-versus-mysql-real-escape-string</a></li>
							<li><a href="http://www.toptal.com/php/a-utf-8-primer-for-php-and-mysql">http://www.toptal.com/php/a-utf-8-primer-for-php-and-mysql</a></li>
						</ul>
					</section>
				</section>

			</div>

			<!-- The navigational controls UI -->
			<aside class="controls">
				<a class="left" href="#">&#x25C4;</a>
				<a class="right" href="#">&#x25BA;</a>
				<a class="up" href="#">&#x25B2;</a>
				<a class="down" href="#">&#x25BC;</a>
				<span id="revealIndex">/</span>
			</aside>

			<!-- Index Link -->
			<aside class="back">
				<a href="index.html">&larr; Back to index</a>
			</aside>

			<!-- ikdoeict.be Link -->
			<a href="http://www.ikdoeict.be/" title="ikdoeict.be" id="ikdoeict">ikdoeict.be</a>

			<!-- Displays presentation progress, max value changes via JS to reflect # of slides -->
			<div class="progress"><span></span></div>

		</div>

		<script src="js/reveal.js"></script>
		<script src="lib/highlight.js"></script>
		<script src="lib/prefixfree.js"></script>
		<script src="lib/css-snippets.js"></script>
		<script src="lib/css-edit.js"></script>
		<script src="lib/incrementable.js"></script>
		<script src="js/main.js"></script>

	</body>
</html>